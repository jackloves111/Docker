<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MoviePiloT环境变量编辑器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { background: #f8fafc; margin: 12px; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .hidden { display: none; }
      .container-limit { max-width: 1600px; margin: 0 auto; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-white border-bottom">
      <div class="container-limit">
        <span class="navbar-brand mb-0 h1">env-editor</span>
        <span class="text-secondary small">ROOT: {{ env_root }} | 文件名: {{ env_filename }}</span>
      </div>
    </nav>

    <main class="container-limit py-3">
      <div class="row g-3">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                  <label class="form-label">文件</label>
                  <select id="fileSelect" class="form-select"></select>
                </div>
                <div class="col-12 col-md-8"></div>
                <div class="col-12">
                  <div class="alert alert-warning d-flex align-items-center gap-2 py-2">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="autoUpdateSwitch">
                      <label class="form-check-label" for="autoUpdateSwitch">自动更新</label>
                    </div>
                    <div id="autoUpdateStatus" class="small"></div>
                  </div>
                </div>
              </div>

              <div class="d-flex flex-wrap gap-2 mt-3">
                <button id="saveBtn" type="button" class="btn btn-primary">保存</button>
                <button id="reloadBtn" type="button" class="btn btn-outline-secondary">重新加载</button>
                <div class="ms-auto small text-secondary d-flex align-items-center" id="status"></div>
              </div>

              <div class="mt-2 small text-secondary" id="hint"></div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 28%;">Key</th>
                      <th style="width: 36%;">中文</th>
                      <th>Value</th>
                    </tr>
                  </thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const state = {
        files: [],
        currentPath: "",
        entries: [],
        nextClientId: 1,
        autoUpdateDesired: false,
      };

      const el = {
        fileSelect: document.getElementById("fileSelect"),
        tbody: document.getElementById("tbody"),
        status: document.getElementById("status"),
        hint: document.getElementById("hint"),
        addBtn: document.getElementById("addBtn"),
        saveBtn: document.getElementById("saveBtn"),
        reloadBtn: document.getElementById("reloadBtn"),
        autoUpdateSwitch: document.getElementById("autoUpdateSwitch"),
        autoUpdateStatus: document.getElementById("autoUpdateStatus"),
      };

      function headers() {
        return { "Content-Type": "application/json" };
      }

      function setStatus(msg, isError=false) {
        el.status.textContent = msg || "";
        el.status.className = (isError ? "small text-danger" : "small text-secondary");
      }

      function escapeHtml(s) {
        return s.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#39;");
      }

      function render() {
        const IMPORTANT_KEYS = new Set(["GITHUB_PROXY","PIP_PROXY"]);
        const AUTO_UPDATE_KEYS = new Set(["MOVIEPILOT_AUTO_UPDATE", "AUTO_UPDATE_RESOURCE"]);
        const rows = state.entries;
        el.tbody.innerHTML = rows.map(e => {
          const idAttr = (e.id !== undefined && e.id !== null) ? `data-id="${e.id}"` : `data-id=""`;
          const quoteAttr = `data-quote="${e.quote || "none"}"`;
          const key = escapeHtml(e.key || "");
          const value = escapeHtml(e.value || "");
          const desc = escapeHtml(e.desc || "");
          const important = IMPORTANT_KEYS.has(e.key || "");
          const isAutoUpdate = AUTO_UPDATE_KEYS.has(e.key || "");
          const descHtml = important
            ? `<span class="badge bg-danger me-2">重要</span><span class="text-danger fw-semibold">${desc}</span>`
            : `<span class="text-secondary">${desc}</span>`;

          let valueHtml;
          if (isAutoUpdate) {
            valueHtml = `<div class="mono text-secondary">${value}</div><input type="hidden" data-field="value" value="${value}" />`;
          } else {
            valueHtml = `<input class="form-control mono" data-field="value" value="${value}" />`;
          }

          return `
            <tr ${idAttr} ${quoteAttr}>
              <td>
                <div class="mono">${key}</div>
              </td>
              <td>
                <div>${descHtml}</div>
              </td>
              <td>
                ${valueHtml}
              </td>
            </tr>
          `;
        }).join("");
        el.hint.textContent = state.currentPath ? `当前文件：${state.currentPath}，共 ${rows.length} 条变量` : "";
        renderAutoUpdateStatus();
      }

      function getEntry(key) {
        for (const e of state.entries) {
          if ((e.key || "") === key) return { exists: true, value: (e.value || "") };
        }
        return { exists: false, value: "" };
      }

      function computeAutoUpdateMode() {
        const e1 = getEntry("MOVIEPILOT_AUTO_UPDATE");
        const e2 = getEntry("AUTO_UPDATE_RESOURCE");
        if (!e1.exists && !e2.exists) return "missing";
        const v1 = (e1.value || "").toLowerCase();
        const v2 = (e2.value || "").toLowerCase();
        const on1 = v1 === "release";
        const off1 = v1 === "false";
        const on2 = v2 === "true";
        const off2 = v2 === "false";
        if (e1.exists && e2.exists && on1 && on2) return "on";
        if (e1.exists && e2.exists && off1 && off2) return "off";
        return "mixed";
      }

      function renderAutoUpdateStatus() {
        const mode = computeAutoUpdateMode();
        const desired = !!state.autoUpdateDesired;
        el.autoUpdateSwitch.checked = desired;

        if (mode === "missing") {
          el.autoUpdateStatus.textContent = "未设置（保存后将写入配置）";
          el.autoUpdateStatus.className = "small text-secondary";
          return;
        }

        if (mode === "mixed") {
          el.autoUpdateStatus.textContent = "状态不一致（保存后将按当前开关统一）";
          el.autoUpdateStatus.className = "small text-warning";
          return;
        }

        if (mode === "on" && desired) {
          el.autoUpdateStatus.textContent = "已开启";
          el.autoUpdateStatus.className = "small text-success";
          return;
        }
        if (mode === "off" && !desired) {
          el.autoUpdateStatus.textContent = "已关闭";
          el.autoUpdateStatus.className = "small text-secondary";
          return;
        }

        if (desired) {
          el.autoUpdateStatus.textContent = "当前为关闭，保存后将开启";
          el.autoUpdateStatus.className = "small text-warning";
        } else {
          el.autoUpdateStatus.textContent = "当前为开启，保存后将关闭";
          el.autoUpdateStatus.className = "small text-warning";
        }
      }

      function readTable() {
        const rows = Array.from(el.tbody.querySelectorAll("tr"));
        const entries = [];
        for (const tr of rows) {
          const idRaw = tr.getAttribute("data-id");
          const id = idRaw === "" ? null : Number(idRaw);
          const quote = tr.getAttribute("data-quote") || "none";
          const valueInput = tr.querySelector('input[data-field="value"]');
          entries.push({
            id: id,
            value: valueInput.value || "",
            quote: quote,
          });
        }
        return entries;
      }

      async function loadFiles() {
        setStatus("加载文件列表...");
        const res = await fetch("/api/files", { headers: headers() });
        if (!res.ok) {
          setStatus("加载失败：" + res.status, true);
          return;
        }
        const data = await res.json();
        state.files = data.files || [];
        if (data.rootExists === false) {
          state.currentPath = "";
          state.entries = [];
          el.fileSelect.innerHTML = "";
          render();
          setStatus("");
          el.hint.textContent = `映射目录不存在：${data.root}。请启动容器时挂载目录到 ${data.root}（例如 -v \"$PWD\":${data.root}）。`;
          return;
        }
        el.fileSelect.innerHTML = state.files.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
        if (state.files.length) {
          state.currentPath = state.files[0];
          el.fileSelect.value = state.currentPath;
          await loadEnv(state.currentPath);
        } else {
          state.currentPath = "";
          state.entries = [];
          render();
          setStatus("");
          el.hint.textContent = `未找到 ${data.root} 目录下的 app.env 文件（会递归查找子目录）。`;
        }
        setStatus("");
      }

      async function loadEnv(path) {
        setStatus("加载 " + path + " ...");
        const url = "/api/env?path=" + encodeURIComponent(path);
        const res = await fetch(url, { headers: headers() });
        if (!res.ok) {
          setStatus("加载失败：" + res.status, true);
          return;
        }
        const data = await res.json();
        state.currentPath = data.path;
        state.entries = (data.entries || []).map(e => ({ ...e, deleted: false, isNew: false }));
        const mode = computeAutoUpdateMode();
        state.autoUpdateDesired = (mode === "on");
        render();
        setStatus("");
      }

      async function saveEnv() {
        if (!state.currentPath) return;
        const activeEntries = readTable();
        const upserts = [];
        if (state.autoUpdateDesired) {
          upserts.push({ key: "MOVIEPILOT_AUTO_UPDATE", value: "release", quote: "single" });
          upserts.push({ key: "AUTO_UPDATE_RESOURCE", value: "true", quote: "single" });
        } else {
          upserts.push({ key: "MOVIEPILOT_AUTO_UPDATE", value: "false", quote: "single" });
          upserts.push({ key: "AUTO_UPDATE_RESOURCE", value: "false", quote: "single" });
        }
        const payload = { path: state.currentPath, entries: activeEntries, upserts: upserts };
        setStatus("保存中...");
        const res = await fetch("/api/env", { method: "PUT", headers: headers(), body: JSON.stringify(payload) });
        if (!res.ok) {
          const text = await res.text();
          setStatus("保存失败：" + res.status + " " + text, true);
          return;
        }
        const data = await res.json();
        state.entries = (data.entries || []).map(e => ({ ...e, deleted: false, isNew: false }));
        render();
        setStatus("已保存");
        setTimeout(() => setStatus(""), 1200);
      }

      el.fileSelect.addEventListener("change", async (e) => {
        await loadEnv(e.target.value);
      });

      // 删除/新增已移除：按要求仅支持编辑 Value

      el.saveBtn.addEventListener("click", async () => {
        await saveEnv();
      });

      el.reloadBtn.addEventListener("click", async () => {
        if (!state.currentPath) return;
        await loadEnv(state.currentPath);
      });

      el.autoUpdateSwitch.addEventListener("change", () => {
        state.autoUpdateDesired = !!el.autoUpdateSwitch.checked;
        renderAutoUpdateStatus();
      });

      (function init() {
        loadFiles();
      })();
    </script>
  </body>
</html>
